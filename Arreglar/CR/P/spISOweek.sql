SET DATEFIRST 7
SET ANSI_NULLS OFF
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET LOCK_TIMEOUT -1
SET QUOTED_IDENTIFIER OFF
SET NOCOUNT ON
SET IMPLICIT_TRANSACTIONS OFF
GO
ALTER PROCEDURE spISOweek
@DATE datetime,
@ISOweek int = 0 OUTPUT

AS
BEGIN
DECLARE @PrimerDia	int
SELECT @PrimerDia = @@DATEFIRST
SET DATEFIRST 1
SET @ISOweek= DATEPART(wk,@DATE)+ 1 -DATEPART(wk,CAST(DATEPART(yy,@DATE) as CHAR(4))+'0104')
IF (@ISOweek=0)
SET @ISOweek=dbo.ISOweek(CAST(DATEPART(yy,@DATE)-1 AS CHAR(4))+'12'+ CAST(24+DATEPART(DAY,@DATE) AS CHAR(2)))+1
IF ((DATEPART(mm,@DATE)=12) AND ((DATEPART(dd,@DATE)-DATEPART(dw,@DATE))>= 28))
SET @ISOweek=1
SET DATEFIRST @PrimerDia
END

