SET DATEFIRST 7
SET ANSI_NULLS OFF
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET LOCK_TIMEOUT -1
SET QUOTED_IDENTIFIER OFF
SET NOCOUNT ON
SET IMPLICIT_TRANSACTIONS OFF
GO
ALTER PROCEDURE spSincroMES

AS BEGIN
DECLARE
@TipoMensaje                                               nvarchar(256),
@iDatos                                            int,
@Brincar                           bit,
@Ok                                                   int,
@OkRef                                             varchar(255),
@ID                                                    int,
@Sistema                         varchar(100),
@Contenido                                                   varchar(100),
@Referencia                                                   varchar(100),
@SubReferencia                                            varchar(100),
@Version                          float,
@Solicitud                        varchar(max),
@Resultado                                                     varchar(max),
@Estatus                           varchar(15),
@FechaEstatus                                              datetime,
@ISOk                                               int,
@ISOkRef                          varchar(255),
@Conversacion                                             uniqueidentifier,
@SincroGUID                                                 uniqueidentifier,
@IntelisisServiceID                        int,
@FechaRecibo                                               datetime,
@UsuarioIS                                                      varchar(10),
@SucursalLocal                                              int,
@SucursalOrigen                                           datetime,
@SucursalDestino                          datetime,
@Detener                         int,
@GUIDSolicitud                                             uniqueidentifier,
@Usuario                      varchar(10),
@Debug                               bit           ,
@contador               int
SET @Debug=0
IF NOT EXISTS(SELECT * FROM IntelisisService WHERE Referencia IN ( 'Intelisis.CXP.InsertarMov.CXP_F',
'Intelisis.CXP.InsertarMov.CXP_CA',
'Intelisis.CXP.InsertarMov.CXP_NC',
'Intelisis.Cuenta.Alm.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Alm',
'Intelisis.Cuenta.CteTipo.Listado',
'Intelisis.Interfaz.Infor.Transferencia.CteTipo',
'Intelisis.Cuenta.Mon.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Mon',
'Intelisis.Interfaz.Infor.Transferencia.Prov',
'Intelisis.Cuenta.Prov.Listado',
'Intelisis.Cuenta.Articulo.Listado',
'Intelisis.Cuenta.Usuario.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Art',
'Intelisis.Interfaz.Infor.Transferencia.ArtContadorLotes',
'Intelisis.Interfaz.Infor.Transferencia.Usuario',
'Intelisis.Cuenta.ArtFam.Listado',
'Intelisis.Interfaz.Infor.Transferencia.ArtFam',
'Intelisis.Cuenta.Departamento.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Departamento',
'Intelisis.Cuenta.Empresa.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Empresa',
'Intelisis.COMS.Mov.Listado',
'Intelisis.Interfaz.Infor.Transferencia.COMS_F',
'Intelisis.Interfaz.Infor.Transferencia.COMS_O',
'Intelisis.Interfaz.Infor.Transferencia.COMS_OC',
'Intelisis.VTAS.Mov.Listado',
'Intelisis.Interfaz.Infor.Transferencia.VTAS_P',
'Intelisis.Interfaz.Infor.Transferencia.VTAS_PR',
'Intelisis.Cuenta.Cte.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Cte',
'Intelisis.Cuenta.Unidad.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Unidad',
'Intelisis.Cuenta.Personal.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Personal',
'Intelisis.COMS.InsertarMov.COMS_O',
'Intelisis.Cuenta.Art.Insertar',
'Intelisis.INV.InsertarMov.INV_E',
'Intelisis.INV.InsertarMov.INV_S',
'Intelisis.INV.InsertarMov.INV_SOL',
'Intelisis.Cuenta.Sucursal.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Sucursal',
'Intelisis.Interfaz.Infor.Solicitud.ObjetivosVentas',
'Intelisis.Interfaz.Infor.Insertar.CancelacionMov',
'Intelisis.Cuenta.Planta.Usuario.Listado',
'Intelisis.Interfaz.Infor.Transferencia.PlantaUsuario',
'Intelisis.Cuenta.Planta.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Planta',
'Intelisis.Cuenta.ArtLinea.Listado',
'Intelisis.Interfaz.Infor.Transferencia.ArtLinea',
'Intelisis.PC.InsertarMov.PC_C',
'Intelisis.Cuenta.MotivoRechazo.Listado',
'Intelisis.Interfaz.Infor.Transferencia.MotivoRechazo',
'Intelisis.Interfaz.Infor.Transferencia.OpcionDetalle',
'Intelisis.Interfaz.Infor.Transferencia.Opcion',
'Intelisis.NOM.Rendimiento.NOM_P',
'Intelisis.Interfaz.Infor.CancelarMov',
'Intelisis.Art.ActCosto',
'Intelisis.COMS_INV.InsertarMov.Maquila',
'Intelisis.INV.InsertarMov.INV_EST')
AND Estatus IN ('SINPROCESAR','ERROR')
AND Sistema ='Intelisis')
RETURN
DECLARE @IntelisisService table
(
ID                                                 int NOT NULL identity(1,1),
IntelisisServiceID                     int NULL,
Sistema                                      varchar(100) COLLATE DATABASE_DEFAULT NULL,
Contenido                                 varchar(100) COLLATE DATABASE_DEFAULT NULL,
Referencia                                                varchar(100) COLLATE DATABASE_DEFAULT NULL,
SubReferencia                          varchar(100) COLLATE DATABASE_DEFAULT NULL,
[Version]                                    float NULL,
Usuario                                       varchar(10) COLLATE DATABASE_DEFAULT NULL,
Solicitud                                     varchar(max) COLLATE DATABASE_DEFAULT NULL,
Resultado                                   varchar(max) COLLATE DATABASE_DEFAULT NULL,
Estatus                                        varchar(15) COLLATE DATABASE_DEFAULT NULL,
FechaEstatus                            datetime NULL,
Ok                                                int NULL,
OkRef                                                          varchar(255) COLLATE DATABASE_DEFAULT NULL,
Detener                                      int NULL DEFAULT 0
)
INSERT @IntelisisService (IntelisisServiceID,  Sistema, Contenido, Referencia, SubReferencia, [Version], Usuario, Solicitud, Resultado, Estatus, FechaEstatus, Ok, OkRef,  Detener)
SELECT  ID,                  Sistema, Contenido, Referencia, SubReferencia, [Version], Usuario, Solicitud, Resultado, Estatus, FechaEstatus, Ok, OkRef,  0
FROM IntelisisService WITH (UPDLOCK, READPAST)
WHERE Referencia IN ('Intelisis.Cuenta.Alm.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Alm',
'Intelisis.Cuenta.CteTipo.Listado',
'Intelisis.Interfaz.Infor.Transferencia.CteTipo',
'Intelisis.Cuenta.Mon.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Mon',
'Intelisis.Interfaz.Infor.Transferencia.Prov',
'Intelisis.Cuenta.Prov.Listado',
'Intelisis.Cuenta.Articulo.Listado',
'Intelisis.Cuenta.Usuario.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Art',
'Intelisis.Interfaz.Infor.Transferencia.ArtContadorLotes',
'Intelisis.Interfaz.Infor.Transferencia.Usuario',
'Intelisis.Cuenta.ArtFam.Listado',
'Intelisis.Interfaz.Infor.Transferencia.ArtFam',
'Intelisis.Cuenta.Departamento.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Departamento',
'Intelisis.Cuenta.Empresa.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Empresa',
'Intelisis.COMS.Mov.Listado',
'Intelisis.Interfaz.Infor.Transferencia.COMS_F',
'Intelisis.Interfaz.Infor.Transferencia.COMS_O',
'Intelisis.Interfaz.Infor.Transferencia.COMS_OC',
'Intelisis.VTAS.Mov.Listado',
'Intelisis.Interfaz.Infor.Transferencia.VTAS_P',
'Intelisis.Interfaz.Infor.Transferencia.VTAS_PR',
'Intelisis.Cuenta.Cte.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Cte',
'Intelisis.Cuenta.Unidad.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Unidad',
'Intelisis.Cuenta.Personal.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Personal',
'Intelisis.COMS.InsertarMov.COMS_O',
'Intelisis.Cuenta.Art.Insertar',
'Intelisis.INV.InsertarMov.INV_E',
'Intelisis.INV.InsertarMov.INV_S',
'Intelisis.INV.InsertarMov.INV_SOL',
'Intelisis.Cuenta.Sucursal.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Sucursal',
'Intelisis.Interfaz.Infor.Solicitud.ObjetivosVentas',
'Intelisis.Interfaz.Infor.Insertar.CancelacionMov',
'Intelisis.Cuenta.Planta.Usuario.Listado',
'Intelisis.Interfaz.Infor.Transferencia.PlantaUsuario',
'Intelisis.Cuenta.Planta.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Planta',
'Intelisis.Cuenta.ArtLinea.Listado',
'Intelisis.Interfaz.Infor.Transferencia.ArtLinea',
'Intelisis.PC.InsertarMov.PC_C',
'Intelisis.Cuenta.MotivoRechazo.Listado',
'Intelisis.Interfaz.Infor.Transferencia.MotivoRechazo',
'Intelisis.Interfaz.Infor.Transferencia.OpcionDetalle',
'Intelisis.Interfaz.Infor.Transferencia.Opcion',
'Intelisis.NOM.Rendimiento.NOM_P',
'Intelisis.Interfaz.Infor.CancelarMov',
'Intelisis.Art.ActCosto',
'Intelisis.COMS_INV.InsertarMov.Maquila',
'Intelisis.INV.InsertarMov.INV_EST'
)
AND Estatus IN ('SINPROCESAR','ERROR')
AND Sistema ='Intelisis'
ORDER BY ID
WHILE EXISTS(SELECT * FROM @IntelisisService WHERE Referencia IN (
'Intelisis.Cuenta.Alm.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Alm',
'Intelisis.Cuenta.CteTipo.Listado',
'Intelisis.Interfaz.Infor.Transferencia.CteTipo',
'Intelisis.Cuenta.Mon.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Mon',
'Intelisis.Interfaz.Infor.Transferencia.Prov',
'Intelisis.Cuenta.Prov.Listado',
'Intelisis.Cuenta.Articulo.Listado',
'Intelisis.Cuenta.Usuario.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Art',
'Intelisis.Interfaz.Infor.Transferencia.ArtContadorLotes',
'Intelisis.Interfaz.Infor.Transferencia.Usuario',
'Intelisis.Cuenta.ArtFam.Listado',
'Intelisis.Interfaz.Infor.Transferencia.ArtFam',
'Intelisis.Cuenta.Departamento.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Departamento',
'Intelisis.Cuenta.Empresa.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Empresa',
'Intelisis.COMS.Mov.Listado',
'Intelisis.Interfaz.Infor.Transferencia.COMS_F',
'Intelisis.Interfaz.Infor.Transferencia.COMS_O',
'Intelisis.Interfaz.Infor.Transferencia.COMS_OC',
'Intelisis.VTAS.Mov.Listado',
'Intelisis.Interfaz.Infor.Transferencia.VTAS_P',
'Intelisis.Interfaz.Infor.Transferencia.VTAS_PR',
'Intelisis.Cuenta.Cte.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Cte',
'Intelisis.Cuenta.Unidad.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Unidad',
'Intelisis.Cuenta.Personal.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Personal',
'Intelisis.COMS.InsertarMov.COMS_O',
'Intelisis.Cuenta.Art.Insertar',
'Intelisis.INV.InsertarMov.INV_E',
'Intelisis.INV.InsertarMov.INV_S',
'Intelisis.INV.InsertarMov.INV_SOL',
'Intelisis.Cuenta.Sucursal.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Sucursal',
'Intelisis.Interfaz.Infor.Solicitud.ObjetivosVentas',
'Intelisis.Interfaz.Infor.Insertar.CancelacionMov',
'Intelisis.Cuenta.Planta.Usuario.Listado',
'Intelisis.Interfaz.Infor.Transferencia.PlantaUsuario',
'Intelisis.Cuenta.Planta.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Planta',
'Intelisis.Cuenta.ArtLinea.Listado',
'Intelisis.Interfaz.Infor.Transferencia.ArtLinea',
'Intelisis.PC.InsertarMov.PC_C',
'Intelisis.Cuenta.MotivoRechazo.Listado',
'Intelisis.Interfaz.Infor.Transferencia.MotivoRechazo',
'Intelisis.Interfaz.Infor.Transferencia.OpcionDetalle',
'Intelisis.Interfaz.Infor.Transferencia.Opcion',
'Intelisis.NOM.Rendimiento.NOM_P',
'Intelisis.Interfaz.Infor.CancelarMov',
'Intelisis.Art.ActCosto',
'Intelisis.COMS_INV.InsertarMov.Maquila',
'Intelisis.INV.InsertarMov.INV_EST')
AND Estatus IN ('SINPROCESAR','ERROR')
AND Sistema ='Intelisis')
AND @Ok IS NULL
BEGIN
SELECT @ID = ID, @IntelisisServiceID = IntelisisServiceID, @Sistema = Sistema, @Contenido = Contenido, @Referencia = Referencia, @SubReferencia = SubReferencia, @Version = [Version],  @UsuarioIS = Usuario, @Solicitud = Solicitud,  @Resultado = Resultado, @Estatus = Estatus, @FechaEstatus = FechaEstatus, @ISOk = Ok, @ISOkRef = OkRef, @Detener = Detener FROM @IntelisisService WHERE Referencia  IN (
'Intelisis.Cuenta.Alm.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Alm',
'Intelisis.Cuenta.CteTipo.Listado',
'Intelisis.Interfaz.Infor.Transferencia.CteTipo',
'Intelisis.Cuenta.Mon.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Mon',
'Intelisis.Interfaz.Infor.Transferencia.Prov',
'Intelisis.Cuenta.Prov.Listado',
'Intelisis.Cuenta.Articulo.Listado',
'Intelisis.Cuenta.Usuario.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Art',
'Intelisis.Interfaz.Infor.Transferencia.ArtContadorLotes',
'Intelisis.Interfaz.Infor.Transferencia.Usuario',
'Intelisis.Cuenta.ArtFam.Listado',
'Intelisis.Interfaz.Infor.Transferencia.ArtFam',
'Intelisis.Cuenta.Departamento.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Departamento',
'Intelisis.Cuenta.Empresa.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Empresa',
'Intelisis.COMS.Mov.Listado',
'Intelisis.Interfaz.Infor.Transferencia.COMS_F',
'Intelisis.Interfaz.Infor.Transferencia.COMS_O',
'Intelisis.Interfaz.Infor.Transferencia.COMS_OC',
'Intelisis.VTAS.Mov.Listado',
'Intelisis.Interfaz.Infor.Transferencia.VTAS_P',
'Intelisis.Interfaz.Infor.Transferencia.VTAS_PR',
'Intelisis.Cuenta.Cte.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Cte',
'Intelisis.Cuenta.Unidad.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Unidad',
'Intelisis.Cuenta.Personal.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Personal',
'Intelisis.COMS.InsertarMov.COMS_O',
'Intelisis.Cuenta.Art.Insertar',
'Intelisis.INV.InsertarMov.INV_E',
'Intelisis.INV.InsertarMov.INV_S',
'Intelisis.INV.InsertarMov.INV_SOL',
'Intelisis.Cuenta.Sucursal.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Sucursal',
'Intelisis.Interfaz.Infor.Solicitud.ObjetivosVentas',
'Intelisis.Interfaz.Infor.Insertar.CancelacionMov',
'Intelisis.Cuenta.Planta.Usuario.Listado',
'Intelisis.Interfaz.Infor.Transferencia.PlantaUsuario',
'Intelisis.Cuenta.Planta.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Planta',
'Intelisis.Cuenta.ArtLinea.Listado',
'Intelisis.Interfaz.Infor.Transferencia.ArtLinea',
'Intelisis.PC.InsertarMov.PC_C',
'Intelisis.Cuenta.MotivoRechazo.Listado',
'Intelisis.Interfaz.Infor.Transferencia.MotivoRechazo',
'Intelisis.Interfaz.Infor.Transferencia.OpcionDetalle',
'Intelisis.Interfaz.Infor.Transferencia.Opcion',
'Intelisis.NOM.Rendimiento.NOM_P',
'Intelisis.Interfaz.Infor.CancelarMov',
'Intelisis.Art.ActCosto',
'Intelisis.COMS_INV.InsertarMov.Maquila',
'Intelisis.INV.InsertarMov.INV_EST')
AND Estatus IN ('SINPROCESAR','ERROR')
AND ID = (SELECT MIN(ID) FROM @IntelisisService WHERE Referencia  IN (
'Intelisis.Cuenta.Alm.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Alm',
'Intelisis.Cuenta.CteTipo.Listado',
'Intelisis.Interfaz.Infor.Transferencia.CteTipo',
'Intelisis.Cuenta.Mon.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Mon',
'Intelisis.Interfaz.Infor.Transferencia.Prov',
'Intelisis.Cuenta.Prov.Listado',
'Intelisis.Cuenta.Articulo.Listado',
'Intelisis.Cuenta.Usuario.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Art',
'Intelisis.Interfaz.Infor.Transferencia.ArtContadorLotes',
'Intelisis.Interfaz.Infor.Transferencia.Usuario',
'Intelisis.Cuenta.ArtFam.Listado',
'Intelisis.Interfaz.Infor.Transferencia.ArtFam',
'Intelisis.Cuenta.Departamento.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Departamento',
'Intelisis.Cuenta.Empresa.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Empresa',
'Intelisis.COMS.Mov.Listado',
'Intelisis.Interfaz.Infor.Transferencia.COMS_F',
'Intelisis.Interfaz.Infor.Transferencia.COMS_O',
'Intelisis.Interfaz.Infor.Transferencia.COMS_OC',
'Intelisis.VTAS.Mov.Listado',
'Intelisis.Interfaz.Infor.Transferencia.VTAS_P',
'Intelisis.Interfaz.Infor.Transferencia.VTAS_PR',
'Intelisis.Cuenta.Cte.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Cte',
'Intelisis.Cuenta.Unidad.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Unidad',
'Intelisis.Cuenta.Personal.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Personal',
'Intelisis.COMS.InsertarMov.COMS_O',
'Intelisis.Cuenta.Art.Insertar',
'Intelisis.INV.InsertarMov.INV_E',
'Intelisis.INV.InsertarMov.INV_S',
'Intelisis.INV.InsertarMov.INV_SOL',
'Intelisis.Cuenta.Sucursal.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Sucursal',
'Intelisis.Interfaz.Infor.Solicitud.ObjetivosVentas',
'Intelisis.Interfaz.Infor.Insertar.CancelacionMov',
'Intelisis.Cuenta.Planta.Usuario.Listado',
'Intelisis.Interfaz.Infor.Transferencia.PlantaUsuario',
'Intelisis.Cuenta.Planta.Listado',
'Intelisis.Interfaz.Infor.Transferencia.Planta',
'Intelisis.Cuenta.ArtLinea.Listado',
'Intelisis.Interfaz.Infor.Transferencia.ArtLinea',
'Intelisis.PC.InsertarMov.PC_C',
'Intelisis.Cuenta.MotivoRechazo.Listado',
'Intelisis.Interfaz.Infor.Transferencia.MotivoRechazo',
'Intelisis.Interfaz.Infor.Transferencia.OpcionDetalle',
'Intelisis.Interfaz.Infor.Transferencia.Opcion',
'Intelisis.NOM.Rendimiento.NOM_P',
'Intelisis.Interfaz.Infor.CancelarMov',
'Intelisis.Art.ActCosto',
'Intelisis.COMS_INV.InsertarMov.Maquila',
'Intelisis.INV.InsertarMov.INV_EST')
AND Estatus IN ('SINPROCESAR','ERROR') )
IF ISNULL(@Detener,0) < 3
BEGIN
DELETE FROM @IntelisisService WHERE ID = @ID
INSERT @IntelisisService (IntelisisServiceID,  Sistema,  Contenido,  Referencia,  SubReferencia,  [Version], Usuario,    Solicitud,  Resultado,  Estatus,  FechaEstatus,  Ok,  OkRef,    Detener)
VALUES (@IntelisisServiceID, @Sistema, @Contenido, @Referencia, @SubReferencia, @Version,  @UsuarioIS, @Solicitud, @Resultado, @Estatus, @FechaEstatus, @Ok, @OkRef,  ISNULL(@Detener,0) + 1)
EXEC spIntelisisServiceProcesar    @IntelisisServiceID
END
IF @Detener = 3 RETURN
END
RETURN
END

