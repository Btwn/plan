SET DATEFIRST 7
SET ANSI_NULLS OFF
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
SET LOCK_TIMEOUT -1
SET QUOTED_IDENTIFIER OFF
SET NOCOUNT ON
SET IMPLICIT_TRANSACTIONS OFF
GO
ALTER VIEW mis_EmbarqueAnalisisMov AS
SELECT
Embarque.ID,
Embarque.Empresa,
EmbarqueMov = Embarque.Mov,
EmbarqueMovID = Embarque.MovID,
Embarque.FechaEmision,
Embarque.Usuario,
EmbarqueMoneda = Embarque.Moneda,
Embarque.Autorizacion,
Embarque.Concepto,
Embarque.Referencia,
Embarque.Observaciones,
Embarque.Estatus,
Embarque.Vehiculo,
Embarque.Ruta,
Embarque.Agente,
Embarque.Peso,
Embarque.Volumen,
Embarque.Paquetes,
Embarque.OrigenTipo,
Embarque.Origen,
Embarque.OrigenID,
Embarque.Ejercicio,
Embarque.Periodo,
Embarque.FechaRegistro,
Embarque.FechaConclusion,
Embarque.FechaCancelacion,
Embarque.FechaSalida,
Embarque.FechaRetorno,
Embarque.Proveedor,
Embarque.Importe,
Embarque.Impuestos,
Embarque.Gastos,
Embarque.Sucursal,
Embarque.UEN,
0 Orden,
EmbarqueDEmbarqueMov = EmbarqueD.EmbarqueMov,
EmbarqueDPaquetes = EmbarqueD.Paquetes,
EmbarqueDObservaciones = EmbarqueD.Observaciones,
EmbarqueD.Estado,
EmbarqueD.FechaHora,
EmbarqueD.Persona,
EmbarqueD.PersonaID,
EmbarqueD.Forma,
EmbarqueDImporte = EmbarqueD.Importe,
EmbarqueDReferencia = EmbarqueD.Referencia,
EmbarqueDSucursal = EmbarqueD.Sucursal,
EmbarqueD.Causa,
EmbarqueMov.AsignadoID,
EmbarqueMov.Accion,
EmbarqueMov.Zona,
EmbarqueMovRuta = EmbarqueMov.Ruta,
EmbarqueMov.ZonaTipo,
EmbarqueMov.OrdenEmbarque,
EmbarqueMovEmpresa = EmbarqueMov.Empresa,
EmbarqueMov.Modulo,
EmbarqueMov.ModuloID,
EmbarqueMovMov = EmbarqueMov.Mov,
EmbarqueMovMovID = EmbarqueMov.MovID,
EmbarqueMovFechaEmision = EmbarqueMov.FechaEmision,
EmbarqueMov.MovReferencia,
EmbarqueMov.MovObservaciones,
EmbarqueMov.MovEstatus,
EmbarqueMov.Almacen,
EmbarqueMov.Cliente,
EmbarqueMov.ClienteEnviarA,
EmbarqueMovProveedor = EmbarqueMov.Proveedor,
EmbarqueMov.AlmacenDestino,
EmbarqueMovPeso = EmbarqueMov.Peso,
EmbarqueMovVolumen = EmbarqueMov.Volumen,
EmbarqueMovPaquetes = EmbarqueMov.Paquetes,
EmbarqueMovImporte = EmbarqueMov.Importe,
EmbarqueMovImpuestos = EmbarqueMov.Impuestos,
EmbarqueMov.Moneda,
EmbarqueMov.TipoCambio,
EmbarqueMov.Condicion,
EmbarqueMov.Vencimiento,
EmbarqueMov.Nombre,
EmbarqueMov.NombreEnvio,
EmbarqueMovSucursal = EmbarqueMov.Sucursal,
EmbarqueMovGastos = EmbarqueMov.Gastos,
VehiculoVehiculo = Vehiculo.Vehiculo,
Vehiculo.Descripcion,
Vehiculo.Placas,
VehiculoVolumen = Vehiculo.Volumen,
VehiculoPeso = Vehiculo.Peso,
VehiculoRuta = Vehiculo.Ruta,
VehiculoEstatus = Vehiculo.Estatus,
AgenteAgente = Agente.Agente,
AgenteNombre = Agente.Nombre,
AgenteEstatus = Agente.Estatus,
Agente.Clase,
Agente.BeneficiarioNombre,
AgenteMoneda = Agente.Moneda,
ProvProveedor = Prov.Proveedor,
ProvNombre = Prov.Nombre,
Prov.Tipo,
ProvEstatus = Prov.Estatus,
MovTipo.Clave,
MovTipo.Factor,
NULL Tarima,
NULL Articulo,
NULL Descripcion1,
NULL Cantidad
FROM
Embarque
JOIN EmbarqueD ON Embarque.ID = EmbarqueD.ID
JOIN EmbarqueMov ON EmbarqueD.EmbarqueMov = EmbarqueMov.ID
JOIN Cte ON EmbarqueMov.Cliente = Cte.Cliente
LEFT OUTER JOIN Vehiculo ON Embarque.Vehiculo = Vehiculo.Vehiculo
LEFT OUTER JOIN Agente ON Embarque.Agente = Agente.Agente AND Agente.Estatus = 'ALTA'
LEFT OUTER JOIN Prov ON Embarque.Proveedor = Prov.Proveedor AND Prov.Estatus = 'ALTA'
JOIN MovTipo ON Embarque.Mov = Movtipo.Mov
WHERE MovTipo.Modulo = 'EMB'
AND MovTipo.Clave IN ('EMB.E', 'EMB.OC')
UNION ALL
SELECT
Embarque.ID,
Embarque.Empresa,
EmbarqueMov = Embarque.Mov,
EmbarqueMovID = Embarque.MovID,
Embarque.FechaEmision,
Embarque.Usuario,
EmbarqueMoneda = Embarque.Moneda,
Embarque.Autorizacion,
Embarque.Concepto,
Embarque.Referencia,
Embarque.Observaciones,
Embarque.Estatus,
Embarque.Vehiculo,
Embarque.Ruta,
Embarque.Agente,
Embarque.Peso,
Embarque.Volumen,
Embarque.Paquetes,
Embarque.OrigenTipo,
Embarque.Origen,
Embarque.OrigenID,
Embarque.Ejercicio,
Embarque.Periodo,
Embarque.FechaRegistro,
Embarque.FechaConclusion,
Embarque.FechaCancelacion,
Embarque.FechaSalida,
Embarque.FechaRetorno,
Embarque.Proveedor,
Embarque.Importe,
Embarque.Impuestos,
Embarque.Gastos,
Embarque.Sucursal,
Embarque.UEN,
EmbarqueD.Orden,
EmbarqueDEmbarqueMov = EmbarqueD.EmbarqueMov,
EmbarqueDPaquetes = EmbarqueD.Paquetes,
EmbarqueDObservaciones = EmbarqueD.Observaciones,
EmbarqueD.Estado,
EmbarqueD.FechaHora,
EmbarqueD.Persona,
EmbarqueD.PersonaID,
EmbarqueD.Forma,
EmbarqueDImporte = EmbarqueD.Importe,
EmbarqueDReferencia = EmbarqueD.Referencia,
EmbarqueDSucursal = EmbarqueD.Sucursal,
EmbarqueD.Causa,
EmbarqueMov.AsignadoID,
EmbarqueMov.Accion,
EmbarqueMov.Zona,
EmbarqueMovRuta = EmbarqueMov.Ruta,
EmbarqueMov.ZonaTipo,
EmbarqueMov.OrdenEmbarque,
EmbarqueMovEmpresa = EmbarqueMov.Empresa,
EmbarqueMov.Modulo,
EmbarqueMov.ModuloID,
EmbarqueMovMov = EmbarqueMov.Mov,
EmbarqueMovMovID = EmbarqueMov.MovID,
EmbarqueMovFechaEmision = EmbarqueMov.FechaEmision,
EmbarqueMov.MovReferencia,
EmbarqueMov.MovObservaciones,
EmbarqueMov.MovEstatus,
EmbarqueMov.Almacen,
EmbarqueMov.Cliente,
EmbarqueMov.ClienteEnviarA,
EmbarqueMovProveedor = EmbarqueMov.Proveedor,
EmbarqueMov.AlmacenDestino,
EmbarqueMovPeso = EmbarqueMov.Peso,
EmbarqueMovVolumen = EmbarqueMov.Volumen,
EmbarqueMovPaquetes = EmbarqueMov.Paquetes,
EmbarqueMovImporte = EmbarqueMov.Importe,
EmbarqueMovImpuestos = EmbarqueMov.Impuestos,
EmbarqueMov.Moneda,
EmbarqueMov.TipoCambio,
EmbarqueMov.Condicion,
EmbarqueMov.Vencimiento,
EmbarqueMov.Nombre,
EmbarqueMov.NombreEnvio,
EmbarqueMovSucursal = EmbarqueMov.Sucursal,
EmbarqueMovGastos = EmbarqueMov.Gastos,
VehiculoVehiculo = Vehiculo.Vehiculo,
Vehiculo.Descripcion,
Vehiculo.Placas,
VehiculoVolumen = Vehiculo.Volumen,
VehiculoPeso = Vehiculo.Peso,
VehiculoRuta = Vehiculo.Ruta,
VehiculoEstatus = Vehiculo.Estatus,
AgenteAgente = Agente.Agente,
AgenteNombre = Agente.Nombre,
AgenteEstatus = Agente.Estatus,
Agente.Clase,
Agente.BeneficiarioNombre,
AgenteMoneda = Agente.Moneda,
ProvProveedor = Prov.Proveedor,
ProvNombre = Prov.Nombre,
Prov.Tipo,
ProvEstatus = Prov.Estatus,
MovTipo.Clave,
MovTipo.Factor,
EmbarqueDArt.Tarima,
Art.Articulo,
Art.Descripcion1,
EmbarqueDArt.Cantidad
FROM
Embarque
JOIN EmbarqueD ON Embarque.ID = EmbarqueD.ID
JOIN EmbarqueMov ON EmbarqueD.EmbarqueMov = EmbarqueMov.ID
JOIN Cte ON EmbarqueMov.Cliente = Cte.Cliente
LEFT OUTER JOIN Vehiculo ON Embarque.Vehiculo = Vehiculo.Vehiculo
LEFT OUTER JOIN Agente ON Embarque.Agente = Agente.Agente AND Agente.Estatus = 'ALTA'
LEFT OUTER JOIN Prov ON Embarque.Proveedor = Prov.Proveedor AND Prov.Estatus = 'ALTA'
JOIN MovTipo ON Embarque.Mov = Movtipo.Mov
JOIN EmbarqueDArt ON Embarque.ID = EmbarqueDArt.ID and EmbarqueD.EmbarqueMov = EmbarqueDArt.EmbarqueMov
LEFT OUTER JOIN VentaD ON EmbarqueDArt.ModuloID=VentaD.ID AND EmbarqueDArt.Renglon=VentaD.Renglon AND EmbarqueDArt.RenglonSub=VentaD.RenglonSub AND EmbarqueDArt.Modulo = 'VTAS'
LEFT OUTER JOIN CompraD ON EmbarqueDArt.ModuloID=CompraD.ID AND EmbarqueDArt.Renglon=CompraD.Renglon AND EmbarqueDArt.RenglonSub=CompraD.RenglonSub AND EmbarqueDArt.Modulo = 'COMS'
JOIN Art ON ISNULL(VentaD.Articulo,CompraD.Articulo)=Art.Articulo
WHERE MovTipo.Modulo = 'EMB'
AND MovTipo.Clave IN ('EMB.E', 'EMB.OC')

